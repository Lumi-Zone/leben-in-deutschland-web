---
import Layout from '../../layouts/Layout.astro';
import QuestionCard from '../../components/QuestionCard';
import questions from '../../data/questions.json';

export function getStaticPaths() {
  const supportedLangs = ['de', 'en', 'tr', 'ar', 'ua', 'ru', 'pl', 'fa', 'ps', 'ro', 'it', 'es'];

  return questions.map((q, index) => {
    // Determine correct index from solution char 'a' -> 0, 'b' -> 1...
    const charCode = q.solution.toLowerCase().charCodeAt(0);
    const correctIndex = charCode - 97; // 'a' is 97

    // Construct full translation map
    const translations = {};
    supportedLangs.forEach(lang => {
      // Keys in JSON are like "q_en", "a1_en" etc.
      // Fallback to German or empty string if missing? 
      // Based on file check, most seem present.
      const qKey = lang === 'de' ? 'q_de' : `q_${lang}`;
      
      // Options logic: 
      // de -> a1_de, a2_de...
      // en -> a1_en, a2_en...
      const getOpt = (num) => q[`a${num}_${lang}`] || q[`a${num}_de`] || "";
      
      translations[lang] = {
        question: q[qKey] || q.q_de || "",
        options: [getOpt(1), getOpt(2), getOpt(3), getOpt(4)]
      };
    });

    const prevId = index > 0 ? questions[index - 1].id : null;
    const nextId = index < questions.length - 1 ? questions[index + 1].id : null;

    return {
      params: { id: q.id.toString() },
      props: { 
        question: {
            id: q.id,
            correct_index: correctIndex,
            translations,
            prevId,
            nextId
        } 
      },
    };
  });
}

const { question } = Astro.props;

// Schema.org JSON-LD (using German as default for SEO)
const schema = {
  "@context": "https://schema.org/",
  "@type": "Quiz",
  "name": `Leben in Deutschland Frage ${question.id}`,
  "mainEntity": {
    "@type": "Question",
    "name": question.translations.de.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": question.translations.de.options[question.correct_index]
    },
    "suggestedAnswer": question.translations.de.options.map((opt, idx) => ({
      "@type": "Answer",
      "text": opt,
      "position": idx
    }))
  }
};
---

<Layout title={`Frage ${question.id}: ${question.translations.de.question}`}>
  <main class="container mx-auto px-4 py-8 min-h-screen bg-gray-50 flex flex-col items-center justify-center">
    
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />

    <div class="w-full mb-8 text-center">
      <a href="/" class="text-blue-600 hover:text-blue-800 font-medium">‚Üê Back to Overview</a>
    </div>

    <QuestionCard 
      client:load 
      id={question.id} 
      data={question.translations}
      correctIndex={question.correct_index}
      prevId={question.prevId}
      nextId={question.nextId}
    />
    
    <div class="mt-12 text-center text-gray-400 text-sm">
      <p>Leben in Deutschland &copy; {new Date().getFullYear()}</p>
    </div>
  </main>
</Layout>
